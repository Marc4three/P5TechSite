<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Polling Test</title>
    <style>
        :root {
            --primary-color: #0071e3;
            --primary-hover: #0077ed;
            --secondary-color: #f5f5f7;
            --text-color: #1d1d1f;
            --text-secondary: #86868b;
            --border-color: #d2d2d7;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --error-color: #ff3b30;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
        }
        
        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            font-size: 40px;
            font-weight: 600;
            margin-bottom: 30px;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 24px;
            font-weight: 600;
            margin: 24px 0 16px;
            letter-spacing: -0.3px;
        }

        .test-panel {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-item {
            background: var(--secondary-color);
            padding: 16px;
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
        }

        .status-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .test-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: inline-block;
            align-self: flex-start;
        }

        .status-running {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
        }

        .status-paused {
            background: rgba(255, 149, 0, 0.1);
            color: var(--warning-color);
        }

        .status-stopped {
            background: rgba(142, 142, 147, 0.1);
            color: var(--text-secondary);
        }

        .status-error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--error-color);
        }

        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 30px;
        }

        .control-button {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--primary-color);
            color: white;
        }

        .control-button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .control-button:active {
            transform: translateY(0);
        }

        .task-list {
            background: var(--secondary-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .task-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .task-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-item.empty {
            color: var(--text-secondary);
            justify-content: center;
            padding: 30px;
        }

        .task-title {
            font-weight: 500;
            color: var(--text-color);
        }

        .task-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(0, 113, 227, 0.1);
            color: var(--primary-color);
        }

        .task-status.completed {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
        }

        .task-status.in-progress {
            background: rgba(255, 149, 0, 0.1);
            color: var(--warning-color);
        }

        .task-status.not-started {
            background: rgba(142, 142, 147, 0.1);
            color: var(--text-secondary);
        }

        .log-panel {
            background: #1c1c1e;
            color: #f5f5f7;
            padding: 20px;
            border-radius: var(--border-radius);
            font-family: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            height: 200px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.5;
        }

        .log-entry {
            margin: 6px 0;
            padding: 4px 0;
        }

        .log-time {
            color: #5ac8fa;
        }

        .log-info {
            color: #34c759;
        }

        .log-error {
            color: #ff453a;
        }

        .refresh-timer {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 32px;
                margin-bottom: 20px;
            }
            
            .test-panel {
                padding: 20px;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .control-panel {
                flex-direction: column;
            }
            
            .control-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Planner Polling Test</h1>
        
        <div class="test-panel">
            <h2>Status Dashboard</h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Polling Status</span>
                    <span id="pollingStatus" class="test-status status-stopped">Stopped</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Update</span>
                    <span id="lastUpdate">Never</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Next Refresh</span>
                    <span id="nextRefresh">N/A</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Total Tasks</span>
                    <span id="totalTasks">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">API Calls</span>
                    <span id="apiCalls">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Tab Visible</span>
                    <span id="tabVisible">Yes</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Auth Status</span>
                    <span id="authStatus" class="test-status status-stopped">Checking...</span>
                </div>
            </div>
            
            <h2>Control Panel</h2>
            <div class="control-panel">
                <button id="startPolling" class="control-button">Start Polling</button>
                <button id="pausePolling" class="control-button">Pause Polling</button>
                <button id="forceRefresh" class="control-button">Force Refresh</button>
                <button id="clearLogs" class="control-button">Clear Logs</button>
                <button id="loginButton" class="control-button">Login</button>
                <button id="checkAuthButton" class="control-button">Check Auth</button>
                <button id="testBucketsButton" class="control-button">Test Buckets</button>
            </div>
            
            <h2>Task Details</h2>
            <div id="taskList" class="task-list">
                <div class="task-item empty">
                    <span>No tasks available</span>
                </div>
            </div>
            
            <h2>Log Panel</h2>
            <div id="logPanel" class="log-panel"></div>
        </div>
    </div>

    <!-- Load MSAL first -->
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    
    <!-- Load configuration files -->
    <script src="auth-config.js"></script>
    <script src="auth-handler.js"></script>
    <script src="planner-config.js"></script>
    <script src="planner-integration.js"></script>
    <script src="smart-planner-service.js"></script>
    
    <script>
        // Global variables
        let plannerIntegration = null;
        let isTracking = false;
        let lastUpdateTime = null;
        let nextRefreshTime = null;
        let refreshTimer = null;
        let apiCallCount = 0;
        let isAuthenticated = false;
        let msalInitialized = false;
        
        // Define MSAL configuration directly in this file
        // This is a fallback in case auth-config.js doesn't initialize MSAL properly
        if (typeof window.msalConfig === 'undefined') {
            window.msalConfig = {
                auth: {
                    clientId: "8a5c3b9d-7e6f-4a1b-9c2d-3e4f5a6b7c8d", // Replace with your actual client ID
                    authority: "https://login.microsoftonline.com/common",
                    redirectUri: window.location.origin,
                    postLogoutRedirectUri: window.location.origin
                },
                cache: {
                    cacheLocation: "sessionStorage",
                    storeAuthStateInCookie: false
                }
            };
        }
        
        // Define login request
        if (typeof window.loginRequest === 'undefined') {
            window.loginRequest = {
                scopes: ["User.Read", "Tasks.ReadWrite", "Tasks.ReadWrite.Shared"]
            };
        }
        
        // Log function for the log panel
        function log(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'log-time';
            timeSpan.textContent = `[${time}] `;
            
            const messageSpan = document.createElement('span');
            messageSpan.className = `log-${type}`;
            messageSpan.textContent = message;
            
            logEntry.appendChild(timeSpan);
            logEntry.appendChild(messageSpan);
            logPanel.appendChild(logEntry);
            
            // Auto-scroll to bottom
            logPanel.scrollTop = logPanel.scrollHeight;
            
            // Also log to console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // Update task list in the UI
        function updateTaskList(tasks) {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            
            if (!tasks || tasks.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'task-item empty';
                emptyItem.innerHTML = '<span>No tasks available</span>';
                taskList.appendChild(emptyItem);
                return;
            }
            
            tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                
                const titleSpan = document.createElement('span');
                titleSpan.className = 'task-title';
                titleSpan.textContent = task.title || 'Untitled Task';
                
                const statusSpan = document.createElement('span');
                statusSpan.className = `task-status ${task.status || 'not-started'}`;
                statusSpan.textContent = task.status || 'Not Started';
                
                taskItem.appendChild(titleSpan);
                taskItem.appendChild(statusSpan);
                taskList.appendChild(taskItem);
            });
        }
        
        // Update metrics in the UI
        function updateMetrics() {
            // Update last update time
            if (lastUpdateTime) {
                document.getElementById('lastUpdate').textContent = lastUpdateTime.toLocaleTimeString();
            }
            
            // Update next refresh time
            if (nextRefreshTime) {
                const now = new Date();
                const timeLeft = Math.max(0, Math.floor((nextRefreshTime - now) / 1000));
                
                if (timeLeft > 0) {
                    document.getElementById('nextRefresh').textContent = `${timeLeft}s`;
                } else {
                    document.getElementById('nextRefresh').textContent = 'Now';
                }
            } else {
                document.getElementById('nextRefresh').textContent = 'N/A';
            }
            
            // Update API call count
            document.getElementById('apiCalls').textContent = apiCallCount;
            
            // Update tab visibility
            document.getElementById('tabVisible').textContent = document.visibilityState === 'visible' ? 'Yes' : 'No';
        }
        
        // Initialize MSAL
        async function initializeMSAL() {
            try {
                log('Initializing MSAL...');
                
                // Check if MSAL is loaded
                if (typeof msal === 'undefined') {
                    throw new Error('MSAL library not loaded');
                }
                
                // Check if auth-config.js has already initialized MSAL
                if (window.msalInstance) {
                    log('MSAL already initialized by auth-config.js');
                    msalInitialized = true;
                    return true;
                }
                
                // If not, try to initialize it manually
                log('MSAL not initialized by auth-config.js, initializing manually...');
                
                // Use our local MSAL config
                log('Using local MSAL configuration');
                
                // Create MSAL instance
                window.msalInstance = new msal.PublicClientApplication(msalConfig);
                
                // Initialize MSAL
                await window.msalInstance.initialize();
                
                log('MSAL initialized successfully');
                msalInitialized = true;
                return true;
            } catch (error) {
                log(`Error initializing MSAL: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Override the auth handler's initialize method for this page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM Content Loaded - Setting up auth handler override');
            
            // Initialize MSAL first
            await initializeMSAL();
            
            // Store the original initialize method
            const originalInitialize = window.AuthHandler.initialize;
            
            // Override the initialize method
            window.AuthHandler.initialize = async function() {
                console.log('Using custom auth handler for polling test page');
                
                // Check if MSAL is loaded
                if (typeof msal === 'undefined') {
                    console.error('MSAL library not loaded');
                    return false;
                }
                
                // Check if MSAL instance exists
                if (!window.msalInstance) {
                    console.error('MSAL instance not initialized');
                    return false;
                }
                
                // Get all accounts
                const accounts = window.msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    const email = accounts[0].username.toLowerCase();
                    if (email === 'marcus.norman@clinovators.com' || 
                        email === 'marcus.norman@p5techsolutions.com') {
                        console.log('Authorized user accessing polling test page:', email);
                        document.getElementById('authStatus').textContent = 'Authorized';
                        document.getElementById('authStatus').style.color = '#34c759';
                        return true;
                    }
                }
                
                // Always return true to prevent redirection
                return true;
            };
            
            // Initialize the page
            console.log('Starting page initialization');
            initializeTestPage();
        });
        
        // Initialize test page
        async function initializeTestPage() {
            try {
                log('Initializing test page...');
                
                // Check authentication first
                isAuthenticated = await checkAuthentication();
                updateAuthStatus();
                
                if (!isAuthenticated) {
                    log('Not authenticated, waiting for login', 'info');
                    return;
                }
                
                // Initialize planner integration
                log('Initializing planner integration...');
                plannerIntegration = new PlannerIntegration();
                
                // Set up task update listener BEFORE initializing
                if (plannerIntegration.smartService) {
                    log('Setting up task update listener...');
                    plannerIntegration.smartService.onTaskUpdate = (tasks) => {
                        log(`Task update received: ${tasks.length} tasks`);
                        lastUpdateTime = new Date();
                        document.getElementById('totalTasks').textContent = tasks.length;
                        updateTaskList(tasks);
                        updateMetrics();
                        log(`Tasks updated: ${tasks.length} tasks found`);
                        
                        // Set next refresh time (30 seconds from now)
                        nextRefreshTime = new Date(lastUpdateTime.getTime() + 30000);
                        
                        // Clear existing timer
                        if (refreshTimer) {
                            clearInterval(refreshTimer);
                        }
                        
                        // Start countdown timer
                        refreshTimer = setInterval(() => {
                            updateMetrics();
                        }, 1000);
                    };
                } else {
                    log('Smart service not available yet', 'warning');
                }
                
                // Now initialize the planner integration
                const initialized = await plannerIntegration.initialize();
                
                if (initialized) {
                    log('Planner integration initialized successfully');
                    
                    // Make plannerIntegration available globally
                    window.plannerIntegration = plannerIntegration;
                    
                    // Start polling only if authenticated and not already tracking
                    if (isAuthenticated && plannerIntegration.smartService && !isTracking) {
                        log('Starting polling...');
                        plannerIntegration.smartService.startTracking();
                        isTracking = true;
                        log('Polling started');
                        
                        // Update UI to show polling is running
                        document.getElementById('pollingStatus').className = 'test-status status-running';
                        document.getElementById('pollingStatus').textContent = 'Running';
                    } else {
                        log('Polling not started: ' + 
                            (!isAuthenticated ? 'Not authenticated' : 
                             !plannerIntegration.smartService ? 'Smart service not available' : 
                             'Already tracking'), 'warning');
                    }
                } else {
                    log('Failed to initialize Planner integration', 'error');
                }
            } catch (error) {
                log(`Error initializing: ${error.message}`, 'error');
                document.getElementById('pollingStatus').className = 'test-status status-error';
                document.getElementById('pollingStatus').textContent = 'Error';
                
                // Show more detailed error information
                const errorDetails = document.createElement('div');
                errorDetails.style.color = '#ff453a';
                errorDetails.style.marginTop = '10px';
                errorDetails.textContent = `Initialization Error: ${error.message}`;
                document.querySelector('.test-panel').appendChild(errorDetails);
            }
        }
        
        // Update authentication status in UI
        function updateAuthStatus() {
            const authStatusElement = document.getElementById('authStatus');
            if (isAuthenticated) {
                authStatusElement.className = 'test-status status-running';
                authStatusElement.textContent = 'Authenticated';
                
                // Hide login button
                document.getElementById('loginButton').style.display = 'none';
            } else {
                authStatusElement.className = 'test-status status-stopped';
                authStatusElement.textContent = 'Not Authenticated';
                
                // Show login button
                document.getElementById('loginButton').style.display = 'inline-block';
            }
        }
        
        // Check if user is authenticated
        async function checkAuthentication() {
            try {
                log('Checking authentication...');
                
                // Check if MSAL instance exists
                if (!window.msalInstance) {
                    log('MSAL instance not initialized', 'error');
                    return false;
                }
                
                // Get all accounts
                const accounts = window.msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    log('No authenticated user found', 'error');
                    return false;
                }
                
                // Set the active account
                const account = accounts[0];
                window.msalInstance.setActiveAccount(account);
                
                // Check if user is authorized
                const email = account.username.toLowerCase();
                if (email === 'marcus.norman@clinovators.com' || 
                    email === 'marcus.norman@p5techsolutions.com') {
                    log(`User authenticated and authorized: ${email}`);
                    isAuthenticated = true;
                    updateAuthStatus();
                    return true;
                } else {
                    log(`User authenticated but not authorized: ${email}`, 'warning');
                    isAuthenticated = true; // Still authenticated, just not authorized
                    updateAuthStatus();
                    return true;
                }
            } catch (error) {
                log(`Authentication check failed: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Login function
        async function login() {
            try {
                log('Attempting to login...');
                
                // Make sure MSAL is initialized
                if (!msalInitialized) {
                    await initializeMSAL();
                }
                
                if (!window.msalInstance) {
                    log('MSAL instance not initialized', 'error');
                    return;
                }
                
                if (window.authHandler) {
                    const success = await window.authHandler.login();
                    if (success) {
                        isAuthenticated = true;
                        updateAuthStatus();
                        log('Login successful');
                        
                        // Reinitialize the page
                        await initializeTestPage();
                    } else {
                        log('Login failed', 'error');
                    }
                } else {
                    // Fallback to old login method
                    try {
                        const response = await window.msalInstance.loginPopup(loginRequest);
                        isAuthenticated = true;
                        updateAuthStatus();
                        log('Login successful');
                        
                        // Reinitialize the page
                        await initializeTestPage();
                    } catch (error) {
                        log(`Login failed: ${error.message}`, 'error');
                    }
                }
            } catch (error) {
                log(`Login error: ${error.message}`, 'error');
            }
        }
        
        // Manual authentication check
        async function manualAuthCheck() {
            try {
                log('Performing manual authentication check...');
                
                // Make sure MSAL is initialized
                if (!msalInitialized) {
                    await initializeMSAL();
                }
                
                // Check if MSAL instance exists
                if (!window.msalInstance) {
                    log('MSAL instance not initialized', 'error');
                    return false;
                }
                
                // Get all accounts
                const accounts = window.msalInstance.getAllAccounts();
                log(`Found ${accounts.length} account(s)`);
                
                if (accounts.length > 0) {
                    const account = accounts[0];
                    log(`User account: ${account.username}`);
                    
                    // Set the active account
                    window.msalInstance.setActiveAccount(account);
                    
                    // Check if user is authorized
                    const email = account.username.toLowerCase();
                    if (email === 'marcus.norman@clinovators.com' || 
                        email === 'marcus.norman@p5techsolutions.com') {
                        log('User is authorized for polling test', 'info');
                        isAuthenticated = true;
                        updateAuthStatus();
                        
                        // Try to initialize planner integration if not already done
                        if (!plannerIntegration) {
                            log('Initializing planner integration...');
                            plannerIntegration = new PlannerIntegration();
                            const initialized = await plannerIntegration.initialize();
                            
                            if (initialized) {
                                log('Planner integration initialized successfully');
                                window.plannerIntegration = plannerIntegration;
                                
                                // Set up task update listener
                                if (plannerIntegration.smartService) {
                                    log('Setting up task update listener...');
                                    plannerIntegration.smartService.onTaskUpdate = (tasks) => {
                                        log(`Task update received: ${tasks.length} tasks`);
                                        lastUpdateTime = new Date();
                                        document.getElementById('totalTasks').textContent = tasks.length;
                                        updateTaskList(tasks);
                                        updateMetrics();
                                        log(`Tasks updated: ${tasks.length} tasks found`);
                                        
                                        // Set next refresh time (30 seconds from now)
                                        nextRefreshTime = new Date(lastUpdateTime.getTime() + 30000);
                                        
                                        // Clear existing timer
                                        if (refreshTimer) {
                                            clearInterval(refreshTimer);
                                        }
                                        
                                        // Start countdown timer
                                        refreshTimer = setInterval(() => {
                                            updateMetrics();
                                        }, 1000);
                                    };
                                }
                                
                                // Enable the start polling button
                                document.getElementById('startPolling').disabled = false;
                            } else {
                                log('Failed to initialize planner integration', 'error');
                            }
                        }
                        
                        return true;
                    } else {
                        log(`User ${email} is not authorized for polling test`, 'error');
                        isAuthenticated = false;
                        updateAuthStatus();
                        return false;
                    }
                } else {
                    log('No authenticated user found', 'error');
                    isAuthenticated = false;
                    updateAuthStatus();
                    return false;
                }
            } catch (error) {
                log(`Manual auth check failed: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Event Listeners
        document.getElementById('startPolling').addEventListener('click', async () => {
            if (!isAuthenticated) {
                log('Cannot start polling: Not authenticated', 'error');
                return;
            }
            
            if (!plannerIntegration) {
                log('Cannot start polling: Planner integration not initialized', 'error');
                return;
            }
            
            if (plannerIntegration.smartService && !isTracking) {
                try {
                    log('Starting polling manually...');
                    
                    // Set up task update listener
                    log('Setting up task update listener...');
                    plannerIntegration.smartService.onTaskUpdate = (tasks) => {
                        log(`Task update received: ${tasks.length} tasks`);
                        lastUpdateTime = new Date();
                        document.getElementById('totalTasks').textContent = tasks.length;
                        updateTaskList(tasks);
                        updateMetrics();
                        log(`Tasks updated: ${tasks.length} tasks found`);
                        
                        // Set next refresh time (30 seconds from now)
                        nextRefreshTime = new Date(lastUpdateTime.getTime() + 30000);
                        
                        // Clear existing timer
                        if (refreshTimer) {
                            clearInterval(refreshTimer);
                        }
                        
                        // Start countdown timer
                        refreshTimer = setInterval(() => {
                            updateMetrics();
                        }, 1000);
                    };
                    
                    plannerIntegration.smartService.startTracking();
                    isTracking = true;
                    document.getElementById('pollingStatus').className = 'test-status status-running';
                    document.getElementById('pollingStatus').textContent = 'Running';
                    log('Polling started');
                    
                    // Force an initial check for updates
                    log('Forcing initial check for updates...');
                    await plannerIntegration.smartService.checkForUpdates();
                    lastUpdateTime = new Date();
                    updateMetrics();
                } catch (error) {
                    log(`Error starting polling: ${error.message}`, 'error');
                }
            } else {
                log('Polling is already running', 'info');
            }
        });

        document.getElementById('pausePolling').addEventListener('click', () => {
            if (plannerIntegration?.smartService && isTracking) {
                plannerIntegration.smartService.stopTracking();
                isTracking = false;
                document.getElementById('pollingStatus').className = 'test-status status-paused';
                document.getElementById('pollingStatus').textContent = 'Paused';
                log('Polling paused');
                
                // Clear refresh timer
                if (refreshTimer) {
                    clearInterval(refreshTimer);
                    refreshTimer = null;
                }
                nextRefreshTime = null;
                updateMetrics();
            } else {
                log('Polling is already paused', 'info');
            }
        });

        document.getElementById('forceRefresh').addEventListener('click', async () => {
            if (!isAuthenticated) {
                log('Cannot refresh: Not authenticated', 'error');
                return;
            }
            
            if (plannerIntegration?.smartService) {
                log('Forcing refresh...');
                
                // Set up task update listener if not already set
                if (!plannerIntegration.smartService.onTaskUpdate) {
                    log('Setting up task update listener...');
                    plannerIntegration.smartService.onTaskUpdate = (tasks) => {
                        log(`Task update received: ${tasks.length} tasks`);
                        lastUpdateTime = new Date();
                        document.getElementById('totalTasks').textContent = tasks.length;
                        updateTaskList(tasks);
                        updateMetrics();
                        log(`Tasks updated: ${tasks.length} tasks found`);
                        
                        // Set next refresh time (30 seconds from now)
                        nextRefreshTime = new Date(lastUpdateTime.getTime() + 30000);
                        
                        // Clear existing timer
                        if (refreshTimer) {
                            clearInterval(refreshTimer);
                        }
                        
                        // Start countdown timer
                        refreshTimer = setInterval(() => {
                            updateMetrics();
                        }, 1000);
                    };
                }
                
                await plannerIntegration.smartService.checkForUpdates();
                lastUpdateTime = new Date();
                updateMetrics();
                log('Refresh completed');
            }
        });

        document.getElementById('clearLogs').addEventListener('click', () => {
            document.getElementById('logPanel').innerHTML = '';
            log('Logs cleared');
        });
        
        // Add check auth button event listener
        document.getElementById('checkAuthButton').addEventListener('click', async () => {
            await manualAuthCheck();
        });

        // Tab visibility handling
        document.addEventListener('visibilitychange', () => {
            updateMetrics();
            log(`Tab visibility changed to: ${document.visibilityState}`);
        });

        // Add login button event listener
        document.getElementById('loginButton').addEventListener('click', login);
        
        // Try to check authentication immediately
        setTimeout(async () => {
            log('Performing initial authentication check...');
            await manualAuthCheck();
            
            // If authenticated, initialize the page
            if (isAuthenticated) {
                log('User is authenticated, initializing page...');
                await initializeTestPage();
            }
        }, 1000);

        // Check authorization on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Checking authorization for polling test page...');
            
            // Wait for MSAL to be initialized
            if (!window.msalInstance) {
                console.log('MSAL not initialized yet, waiting...');
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Check if user is authorized
            if (window.isAuthorizedForPollingTest()) {
                console.log('User is authorized for polling test page');
                document.getElementById('authStatus').textContent = 'Authorized';
                document.getElementById('authStatus').style.color = '#34c759';
                document.getElementById('startPolling').disabled = false;
            } else {
                console.log('User is not authorized for polling test page');
                document.getElementById('authStatus').textContent = 'Not Authorized';
                document.getElementById('authStatus').style.color = '#ff3b30';
                document.getElementById('startPolling').disabled = true;
            }
        });

        // Override window.location.href to prevent redirection
        const originalHref = window.location.href;
        Object.defineProperty(window.location, 'href', {
            configurable: true,
            get: function() {
                return originalHref;
            },
            set: function(value) {
                console.log('Navigation attempt to:', value);
                
                // Allow navigation to specific pages
                if (value.includes('login.html') || 
                    value.includes('home.html') || 
                    value.includes('customer-portal.html') || 
                    value.includes('admin-portal.html') || 
                    value.includes('Project-Price-Calculator.html') || 
                    value.includes('release-planner.html') || 
                    value.includes('repository.html') || 
                    value.includes('polling-test.html')) {
                    console.log('Allowing navigation to:', value);
                    window.location.replace(value);
                } else {
                    console.log('Preventing navigation to:', value);
                }
            }
        });

        // Override window.location.replace to prevent redirection
        const originalReplace = window.location.replace;
        window.location.replace = function(url) {
            console.log('Replace attempt to:', url);
            
            // Allow navigation to specific pages
            if (url.includes('login.html') || 
                url.includes('home.html') || 
                url.includes('customer-portal.html') || 
                url.includes('admin-portal.html') || 
                url.includes('Project-Price-Calculator.html') || 
                url.includes('release-planner.html') || 
                url.includes('repository.html') || 
                url.includes('polling-test.html')) {
                console.log('Allowing replace to:', url);
                originalReplace.call(window.location, url);
            } else {
                console.log('Preventing replace to:', url);
            }
        };

        // Add test buckets button event listener
        document.getElementById('testBucketsButton').addEventListener('click', async () => {
            if (!isAuthenticated) {
                log('Cannot test buckets: Not authenticated', 'error');
                return;
            }
            
            if (!plannerIntegration) {
                log('Cannot test buckets: Planner integration not initialized', 'error');
                return;
            }
            
            try {
                log('Testing bucket fetching...');
                
                // Get the first plan ID from the available plans
                const plans = await plannerIntegration.discoverPlans();
                if (!plans || plans.length === 0) {
                    log('No plans available to test buckets', 'error');
                    return;
                }
                
                const planId = plans[0].id;
                log(`Testing buckets for plan: ${planId}`);
                
                // Fetch buckets for the plan
                const buckets = await plannerIntegration.getBuckets(planId);
                log(`Found ${buckets.length} buckets:`, 'info');
                
                // Log each bucket's details
                buckets.forEach(bucket => {
                    log(`Bucket: ${bucket.name} (ID: ${bucket.id})`, 'info');
                });
                
                // Update the task list with bucket information
                updateTaskList(buckets.map(bucket => ({
                    title: bucket.name,
                    status: 'bucket',
                    id: bucket.id
                })));
                
                log('Bucket test completed successfully', 'info');
            } catch (error) {
                log(`Error testing buckets: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html> 